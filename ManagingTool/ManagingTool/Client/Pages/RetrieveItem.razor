@page "/RetrieveItem"
@using AntDesign.TableModels
@using AntDesign.Core.Extensions
@inject ItemService ItemService
@inject MailService MailService
@inject IMessageService _message
@inject INotificationService _notice


<h3>Retrieve Item</h3>

<div>
    <RadioGroup @bind-Value="@searchType">
        <Radio RadioButton Value="@("ItemID")">ItemID</Radio>
        <Radio RadioButton Value="@("ItemCode")">ItemCode</Radio>
        <Radio RadioButton Value="@("UserID")">UserID</Radio>
    </RadioGroup>
</div>

<div class="mb-3">
    Input Number:
    <input type="number" @bind="searchValue" class="form-label" name="SearchValue">Input Number</input>
    <button class="btn btn-primary" @onclick="GetUserItemList">Search</button>
</div>

<Table TItem="UserItem" DataSource="@UserItemDataSet" @bind-SelectedRows="selectedRows">
    <Selection Key="@(context.ItemId.ToString())" Disabled="@(context.IsDestroyed == true)" />
    <GenerateColumns Range="0.." Definitions=definitions />
</Table>


<button class="btn btn-primary" @onclick="RetrieveButtonClick">Retrieve</button>

<div>
    <Checkbox @bind-Checked="sendMail">
       Send Mail When Retrieve Item
    </Checkbox>
</div>


@code
{
    string searchType = "ItemID";
    Int64 searchValue = 0;
    IEnumerable<UserItem> selectedRows;
    Boolean sendMail = true;

    List<UserItem> UserItemDataSet = new();
    MailForm? mailForm = new MailForm
    {
        Title = "Retrieve Item",
        Content = "Your Item has been retrieved.",
        ItemCode = 0,
        ItemCount = 0
    };

    void definitions(string propertyName, object column)
    {
        column.SetValue("Sortable", true);
        column.SetValue("Filterable", true);
    }

    private async Task RetrieveButtonClick()
    {
        string key = $"open{DateTime.Now}";
        RenderFragment confirmbtn = 
    @<Button Type="@ButtonType.Primary" OnClick="async () => { await RetrieveUserItem(); await _notice.Close(key); await SuccessMessage(); }">
                                    confirm
        </Button>
    ;

        await _notice.Open(new NotificationConfig()
        {
            Message = "!WARNING!",
            Description = "이 행동은 되돌릴 수 없습니다. 정말로 데이터를 삭제하시겠습니까?",
            Duration = 0,
            Key = key,
            Placement = NotificationPlacement.Top,
            Btn = confirmbtn
        });
    }

    private async Task SuccessMessage()
    {
        await _message.Success("Retrieve Item Success!");
    }

    async Task GetUserItemList()
    {
        UserItemDataSet.Clear();

        var response = await ItemService.GetUserItemList(searchType, searchValue);
        UserItemDataSet = response.UserItem;
    }

    async Task RetrieveUserItem()
    {
        if (selectedRows != null)
        {
            if (sendMail == true)
            {
                var response = await ItemService.RetrieveUserItem(selectedRows, mailForm);
            }
            else
            {
                var response = await ItemService.RetrieveUserItem(selectedRows, null);
            }

            await GetUserItemList();
        }
    }

}
